@model pb_category.Models.CalculateAViewModels
@{
    ViewBag.Title = "Расчет";
}
@using (Ajax.BeginForm("Steps", new AjaxOptions
{
    HttpMethod = "POST",
    InsertionMode = InsertionMode.ReplaceWith,
    UpdateTargetId = "Steps",
    OnComplete = "UpdateA",
}))
{
    @Html.AntiForgeryToken()
    <div class="row">
        <div class="total">
            @{ Html.RenderPartial("Total"); }
        </div>
        <div class="panel-group" id="accordion">
            @{ Html.RenderPartial("Steps"); }
        </div>
    </div>
}
<script>
    function UpdateA(ajaxContext) {
        $.ajax({
            url: "/Calculate/GetValueA",
            cache: false,
            type: "GET",
            dataType: "json",
            success: function (answer) {
                $('*[id^="alert"]').empty();
                for (var i = 0; i < answer.length; i++) {
                    var Step = answer[i];
                    for (var j = 0; j < Step.AllInputs.length; j++) {
                        var inputs = Step.AllInputs[j];
                        if (inputs.Error) {
                            $('#alert' + inputs.Name).html(inputs.Error);
                            if ($('[href*="collapse' + Step.Number + '"]').hasClass('collapsed')) {
                                jQuery('[href*="collapse' + Step.Number + '"]').click();
                            }
                        }
                        else {
                            $('#' + inputs.Name).val(inputs.Value);
                        }
                    }
                    if (Step.FinishValue != null) {
                        if ($('#Step' + Step.Number + 'Header').hasClass('invisible')) {
                            $('#Step' + Step.Number + 'Header').removeClass('invisible');
                        }
                        $('#Step' + Step.Number + 'HeaderValue').html(Step.FinishValue);
                        if(Step.Number == 7){
                            $('#Answer').val('Рассчитать категорию');
                        }
                        if(Step.Number == 8){
                            $('#Answer').prependTo('#accordion').slideDown();
                            $('#Answer').val('Пересчитать категорию');
                            $("html, body").animate({ scrollTop: 0 });
                        }
                        if (Step.Number == 9) {
                            var value = parseInt(Step.FinishValue, 10);
                            if (value < 5) {
                                if (!$('#Category').hasClass('invisible')) {
                                    $('#Category').addClass('invisible');
                                }
                            }
                            if (value >= 5) {
                                if ($('#Category').hasClass('invisible')) {
                                    $('#Category').removeClass('invisible');
                                }
                            }
                        }
                    }
                }
                if ($('#Answer').val() != 'Пересчитать категорию') {
                    $('#Answer').prependTo('#Steps').slideDown();
                }
            }
        });
    }
</script>